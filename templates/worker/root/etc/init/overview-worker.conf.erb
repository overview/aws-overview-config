description "Overview worker"
author "Overview Project"

start on runlevel [2345]
stop on runlevel [016]

setuid overview
setgid overview
chdir /opt/overview
console output

respawn

env SMTP_USERNAME="<%= secrets['smtp-username'] %>"
env SMTP_PASSWORD="<%= secrets['smtp-password'] %>"
env SMTP_HOST="<%= smtp_host %>"
env SMTP_PORT="<%= smtp_port %>"
env SMTP_SSL="<%= smtp_ssl && 'true' || 'false' %>"
env LOGGER_SMTP_FROM="<%= logger_smtp_from %>"
env LOGGER_SMTP_TO="<%= logger_smtp_to %>"
env LOGGER_SMTP_SUBJECT_PREFIX="<%= logger_worker_smtp_subject_prefix %>"
env ES_CLUSTER_NAME="<%= es_cluster_name %>"
env ES_ACCESS_KEY="<%= secrets['searchindex_access_key'] %>"
env ES_SECRET_KEY="<%= secrets['searchindex_secret_key'] %>"

<%# TODO: remove database_url from the commandline %>
exec /usr/bin/java \
       -cp "<%= managed_code_path %>/worker/current/*" \
       -Ddatasource.default.driver=org.postgresql.Driver \
       -Ddatasource.default.url="<%= database_url %>" \
       -Dlogback.configurationFile=workerprodlog.xml \
       -Xmx3500m \
       JobHandler \
       2>&1 | logger -p local1.notice
