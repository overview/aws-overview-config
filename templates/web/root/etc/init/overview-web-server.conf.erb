description "Overview web server (only listens on localhost)"
author "Overview Project"

start on runlevel [2345]
stop on runlevel [016]

setuid overview
setgid overview
chdir /opt/overview
console output

respawn

env APPLICATION_SECRET="<%= secrets['application-secret'] %>"

env AWS_ACCESS_KEY_ID="<%= secrets['aws-access-key-id'] %>"
env AWS_SECRET_KEY="<%= secrets['aws-secret-key'] %>"

env BLOB_STORAGE_PAGE_DATA_LOCATION="<%= config['blob-storage-page-data-location'] %>"
env BLOB_STORAGE_FILE_CONTENTS_LOCATION="<%= config['blob-storage-file-contents-location'] %>"
env BLOB_STORAGE_FILE_VIEW_LOCATION="<%= config['blob-storage-file-view-location'] %>"

env DATABASE_SERVER_NAME="<%= database_ip %>"
env DATABASE_NAME="<%= database_dbname %>"
env DATABASE_USERNAME="<%= database_username %>"
env DATABASE_PASSWORD="<%= secrets['database-password'] %>"
env DATABASE_SSL_FACTORY="org.postgresql.ssl.NonValidatingFactory"

env ES_CLUSTER_NAME="<%= config['es_cluster_name'] %>"
env ES_HOSTS="<%= searchindex_ip %>:9300"

env GOOGLE_ANALYTICS_ID="<%= google_analytics_id %>"

env INTERCOM_APP_ID="<%= secrets['intercom-app-id'] %>"
env INTERCOM_SECRET_KEY="<%= secrets['intercom-secret-key'] %>"

env LOGGER_SMTP_FROM="<%= logger_smtp_from %>"
env LOGGER_SMTP_TO="<%= logger_smtp_to %>"
env LOGGER_SMTP_SUBJECT_PREFIX="<%= logger_smtp_subject_prefix %>"

env MAIL_FROM="<%= mail_from %>"
env SMTP_USERNAME="<%= secrets['smtp-username'] %>"
env SMTP_PASSWORD="<%= secrets['smtp-password'] %>"
env SMTP_HOST="<%= smtp_host %>"
env SMTP_PORT="<%= smtp_port %>"
env SMTP_SSL="<%= smtp_ssl && 'true' || 'false' %>"

env MAILCHIMP_API_KEY="<%= secrets['mailchimp-api-key'] %>"
env MAILCHIMP_LIST_ID="<%= secrets['mailchimp-list-id'] %>"

env MESSAGE_BROKER_URI="tcp://<%= message_broker_ip %>:61613"
env MESSAGE_BROKER_USERNAME="<%= secrets['message_broker_username'] %>"
env MESSAGE_BROKER_PASSWORD="<%= secrets['message_broker_password'] %>"

env REDIS_HOST="<%= redis_ip %>"
env REDIS_PORT="<%= redis_port %>"

# FIXME remove the -Xmx. We have it because of
# https://www.pivotaltracker.com/n/projects/928628/stories/71065558
# but there's no good reason for us to be using lots of RAM _anywhere_
# in the frontend.
exec /usr/bin/java \
       -Xmx3000M \
       -cp "<%= managed_code_path %>/frontend/*" \
       -Dconfig.resource=production.conf \
       -Dlogger.resource=productionlog.xml \
       -Dhttp.port=<%= web_port %> \
       -DapplyEvolutions.default=true \
       -Ddb.default.driver=org.postgresql.Driver \
       -Dpidfile.path=/tmp/overview-web-server-useless-pid-file \
       -Duser.timezone=UTC \
       play.core.server.NettyServer /opt/overview \
       2>&1 | logger -p local1.notice
