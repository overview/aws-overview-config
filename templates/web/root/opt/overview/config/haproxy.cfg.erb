global
  log /dev/log local0
  user haproxy
  group haproxy

defaults
  log global
  option httplog
  maxconn 4096

frontend http_redirect
  mode http
  bind 0.0.0.0:80
  timeout client 50s
  redirect prefix https://<%= canonical_host %> code 301 

frontend overview_frontend
  mode http

  # Keys from https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
  #
  # haproxy <= 1.5dev17 need us to specify a named curve to support perfect
  # forward secrecy. (Above  that, the default is prime256v1.)
  # https://github.com/macro/haproxy/commit/6924ef8b12ad6f935bb5287ff4b2ae17bdbbf928
  bind 0.0.0.0:443 ssl crt <%= config_path %>/ssl-cert-and-pk.pem ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS ecdhe prime256v1

  timeout client 50s

  acl canonical_url hdr_dom(Host) eq <%= canonical_host %>
  redirect prefix https://<%= canonical_host %> code 301 if !canonical_url

  # Add the HSTS header with a 1 year max-age
  rspadd Strict-Transport-Security:\ max-age=31536000

  default_backend overview_backend

backend overview_backend
  mode http
  timeout connect 5s
  timeout server 30s

  server overview 127.0.0.1:<%= web_port %>
